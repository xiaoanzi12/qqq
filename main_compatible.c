/*******************************************************************************
 * 文件名：main_compatible.c
 * 功能：STC15单片机8位LED流水灯程序（兼容版本）
 * 芯片型号：STC15F2K60S2（或其他STC15系列）
 * 晶振频率：11.0592MHz（可根据实际调整）
 * 说明：本版本使用标准reg52.h头文件，兼容性更好
 * 作者：cto.new
 * 日期：2024
 ******************************************************************************/

#include <reg52.h>   // 标准8051头文件（兼容性好）
#include <intrins.h> // 包含_nop_()等intrinsic函数

/*******************************************************************************
 * 硬件连接说明：
 * 
 * LED接口：P1口（P1.0 - P1.7）
 * 
 * 电路连接方式（推荐使用共阳极接法）：
 * - LED共阳极连接到 VCC (+5V)
 * - LED阴极通过限流电阻（330Ω-1KΩ）连接到单片机P1口
 * - 当P1.x输出低电平(0)时，LED点亮
 * - 当P1.x输出高电平(1)时，LED熄灭
 * 
 * 引脚定义：
 * P1.0 -> LED0（第1个LED）
 * P1.1 -> LED1（第2个LED）
 * P1.2 -> LED2（第3个LED）
 * P1.3 -> LED3（第4个LED）
 * P1.4 -> LED4（第5个LED）
 * P1.5 -> LED5（第6个LED）
 * P1.6 -> LED6（第7个LED）
 * P1.7 -> LED7（第8个LED）
 * 
 * 注意事项：
 * 1. 本版本不使用STC15特有的端口模式配置，兼容性更好
 * 2. 如果使用共阴极接法，需要修改LED_TABLE数组（取反）
 * 3. 限流电阻阻值根据LED规格和供电电压选择
 ******************************************************************************/

// STC15特有寄存器定义（如果需要推挽输出模式）
sfr P1M0 = 0x92;  // P1口输出模式配置0
sfr P1M1 = 0x91;  // P1口输出模式配置1

// 延迟时间定义（毫秒）
#define DELAY_MS 250  // 流水灯延迟时间，可调整（200-300ms）

/*******************************************************************************
 * 函数名：Delay_ms
 * 功能：软件延迟函数（毫秒级）
 * 参数：ms - 延迟时间（毫秒）
 * 返回值：无
 * 说明：基于11.0592MHz晶振，实际延迟时间约为参数值
 ******************************************************************************/
void Delay_ms(unsigned int ms)
{
    unsigned int i, j;
    for(i = 0; i < ms; i++)
    {
        // 约1ms的延迟循环（11.0592MHz晶振）
        for(j = 0; j < 120; j++)
        {
            _nop_();
            _nop_();
            _nop_();
            _nop_();
        }
    }
}

/*******************************************************************************
 * 函数名：System_Init
 * 功能：系统初始化
 * 参数：无
 * 返回值：无
 * 说明：配置P1口为推挽输出模式，提高驱动能力
 ******************************************************************************/
void System_Init(void)
{
    // 配置P1口为推挽输出模式（STC15特有，可选）
    // 如果编译出错，可以注释掉下面两行
    P1M1 = 0x00;  // P1口配置寄存器1
    P1M0 = 0xFF;  // P1口配置寄存器0（推挽输出）
    
    P1 = 0xFF;    // 初始化P1口，全部输出高电平（LED全灭）
}

/*******************************************************************************
 * 函数名：main
 * 功能：主函数
 * 参数：无
 * 返回值：无
 * 说明：实现8位LED单向流水灯效果
 ******************************************************************************/
void main(void)
{
    unsigned char i;
    
    // LED流水灯码表（共阳极接法，低电平点亮）
    // 每个字节代表一个LED状态，0表示点亮，1表示熄灭
    unsigned char code LED_TABLE[8] = {
        0xFE,  // 11111110 - LED0点亮
        0xFD,  // 11111101 - LED1点亮
        0xFB,  // 11111011 - LED2点亮
        0xF7,  // 11110111 - LED3点亮
        0xEF,  // 11101111 - LED4点亮
        0xDF,  // 11011111 - LED5点亮
        0xBF,  // 10111111 - LED6点亮
        0x7F   // 01111111 - LED7点亮
    };
    
    // 系统初始化
    System_Init();
    
    // 主循环：无限循环实现流水灯效果
    while(1)
    {
        // 使用查表法实现流水灯
        for(i = 0; i < 8; i++)
        {
            P1 = LED_TABLE[i];   // 输出LED模式到P1口
            Delay_ms(DELAY_MS);  // 延迟，控制流水速度
        }
    }
}

/*******************************************************************************
 * 使用说明：
 * 
 * 1. 本文件是main.c的兼容版本，使用标准reg52.h头文件
 * 2. 如果编译时找不到STC15.h，可以使用本文件替代
 * 3. 功能与main.c完全相同
 * 4. 在Keil项目中，使用本文件时请移除main.c，避免重复定义
 * 
 ******************************************************************************/
